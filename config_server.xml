<?xml version="1.1" encoding="UTF-8"?>
<smarthome>
    <themylog>unix:///run/themylog/themylog.sock</themylog>

    <objects>
        <server_lpt class="devices.diy.parallel_port" />

        <!-- Освещение -->
        <lighting_box class="devices.diy.serial_bit_vector" device="/dev/ttyS5" baudrate="9600" length="8" />
        <corridor_light             class="devices.generic.on_off_device" property="lighting_box.bit0" />
        <balcony_light              class="devices.generic.on_off_device" property="lighting_box.bit1" />
        <room_recreation_light      class="devices.generic.on_off_device" property="lighting_box.bit2" />
        <bathroom_light             class="devices.generic.on_off_device" property="lighting_box.bit3" />
        <kitchen_light              class="devices.generic.on_off_device" property="lighting_box.bit4" />
        <kitchen_work_zone_light    class="devices.generic.on_off_device" property="lighting_box.bit5" />
        <room_work_light            class="devices.generic.on_off_device" property="lighting_box.bit6" />
        <bathroom_fan               class="devices.generic.on_off_device" property="lighting_box.bit7" />

        <!-- Крыльцо -->
        <intercom class="household.intercom" receiver_control="server_lpt.Select" door_control="server_lpt.InitOut"
                  audio_input="hw:CARD=PCH,DEV=0" />
        <intercom_sound_player class="devices.multimedia.alsa_sound_player" device="intercom" />

        <!-- Подъезд -->
        <front_door_bell_button class="devices.generic.button" property="server_lpt.Error" released_state="True" />
        <front_door_bell class="household.door_bell" sound_player="hall_loudspeakers"
                         files="sound/door_bell/souvlaki1.wav, sound/door_bell/souvlaki2.wav,
                                sound/door_bell/souvlaki3.wav, sound/door_bell/souvlaki4.wav"
                         reset_sequence_timeout="10" />

        <!-- Прихожая -->
        <front_door class="household.door" property="server_lpt.Busy" />
        <themylogin_keys_holder class="household.keys_holder" property="server_lpt.Acknowledge" />
        <owner_watcher class="watchers.owner_presence_watcher"
                       front_door="front_door" keys_holders="themylogin_keys_holder"
                       speech_synthesizer="hall_speech_synthesizer"
                       everybody_leaving_message="Умный дом опустел. Запускается процесс самоликвидации.
                                                  Десять. Девять. Восемь. Семь. Шесть. Пять. Четыре. Три. Два. Один."
                       everybody_leaving_canceled_message="Самоликвидация остановлена" />

        <hall_loudspeakers class="devices.multimedia.alsa_sound_player" device="default" />
        <hall_speech_synthesizer class="servants.speech_synthesizer" sound_player="hall_loudspeakers" />

        <!-- Ванная -->
        <bathroom_door class="household.door" property="server_lpt.PaperOut" />

        <!-- Группы электроприборов -->
        <all_lightning_except_projector class="devices.generic.on_off_device_group"
                                        properties="corridor_light.on, balcony_light.on, room_recreation_light.on,
                                                    bathroom_light.on, kitchen_light.on, room_work_light.on,
                                                    desktop_screens_smooth.on, desktop_light.on" />
        <all_lightning class="devices.generic.on_off_device_group"
                       properties="all_lightning_except_projector.on, projector_smooth.on" />

        <!-- Сон -->
        <!-- false_to_true_interrupt_immediately="False" потому что если встал в 11:57, включив свет в ванной, в
             11:59:05 его выключил, в 11:59:09 включил компьютер, то встал в 11:57, а не 11:59:09 -->
        <!-- true_to_false_interrupt_immediately="True" потому что, если лёг спать в 02:04, а в 02:07 встал погуглить,
             3 минуты погуглил и снова спать, а в 02:24 сработает таймер, то получится, что лёг спать в 02:04,
             хотя на самом деле в 02:10 -->
        <sleep_tracker class="watchers.expirable_hysteresis"
                       expression="not (owner_watcher.anybody_at_home and not all_lightning.on)"

                       false_to_true_signal="woke_up"
                       false_to_true_timeout="1200"
                       false_to_true_interrupt_immediately="False"

                       true_to_false_signal="fall_asleep"
                       true_to_false_timeout="1200"
                       true_to_false_interrupt_immediately="True"

                       false_property="sleeping"
                       true_property="conscious" />
    </objects>

    <!-- Открывать домофон кому ни попадя -->
    <on signal="intercom.listener_input" input="'BELL'">
        <call method="intercom.tell_listener" message="'DO_NOT_LISTEN'" />
        <call method="intercom.take_receiver" />
        <call method="intercom_sound_player.play" path="os.path.join(DATA_DIR, 'sound/intercom/cat.wav')">
            <finish>
                <call method="intercom.open_door" />
                <call method="intercom.put_receiver_down" />
                <call method="intercom.tell_listener" message="'LISTEN_FOR_BELL'" />
            </finish>
        </call>
    </on>

    <!-- Звонить в дверь -->
    <on signal="front_door_bell_button.pressed">
        <call method="front_door_bell.ring" />
    </on>

    <!-- Включать свет при входе в ванную -->
    <on signal="bathroom_door.opened">
        <set property="bathroom_light.on" value="True" />
    </on>
</smarthome>
